name: Build & Deploy to EC2

on:
  push:
    branches:
      - main        # Triggers on every push to main branch

jobs:
  # â”€â”€ Job 1: Build & Push Docker Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Backend Image
        run: docker build -t backend:latest ./backend

      - name: Build Portfolio Image
        run: docker build -t portfolio:latest ./portfolio

      - name: Build Dashboard Image
        run: docker build -t dashboard:latest ./dashboard

      - name: Save Docker Images as TAR files
        run: |
          docker save backend:latest | gzip > backend.tar.gz
          docker save portfolio:latest | gzip > portfolio.tar.gz
          docker save dashboard:latest | gzip > dashboard.tar.gz

      - name: Upload Images as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: docker-images
          path: |
            backend.tar.gz
            portfolio.tar.gz
            dashboard.tar.gz

  # â”€â”€ Job 2: Deploy to EC2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build       # Runs only after build job succeeds

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Download Docker Images
        uses: actions/download-artifact@v3
        with:
          name: docker-images

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Copy Docker Images to EC2
        run: |
          scp -i ~/.ssh/deploy_key.pem backend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/
          scp -i ~/.ssh/deploy_key.pem portfolio.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/
          scp -i ~/.ssh/deploy_key.pem dashboard.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/

      - name: Copy Docker Compose File to EC2
        run: |
          scp -i ~/.ssh/deploy_key.pem docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/deploy_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

            echo "ðŸš€ Loading Docker Images..."
            docker load < backend.tar.gz
            docker load < portfolio.tar.gz
            docker load < dashboard.tar.gz

            echo "ðŸ›‘ Stopping Old Containers..."
            docker-compose -f docker-compose.prod.yml down

            echo "â–¶ï¸ Starting New Containers..."
            export MONGO_ROOT_USER=${{ secrets.MONGO_ROOT_USER }}
            export MONGO_ROOT_PASSWORD=${{ secrets.MONGO_ROOT_PASSWORD }}
            export MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}
            export JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            export JWT_EXPIRES=${{ secrets.JWT_EXPIRES }}
            export COOKIE_EXPIRE=${{ secrets.COOKIE_EXPIRE }}
            export CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            export CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            export CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
            export SMTP_SERVICE=${{ secrets.SMTP_SERVICE }}
            export SMTP_HOST=${{ secrets.SMTP_HOST }}
            export SMTP_PORT=${{ secrets.SMTP_PORT }}
            export SMTP_MAIL=${{ secrets.SMTP_MAIL }}
            export SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
            export DOMAIN=${{ secrets.DOMAIN }}

            docker-compose -f docker-compose.prod.yml up -d

            echo "ðŸ§¹ Cleaning Up..."
            rm -f backend.tar.gz portfolio.tar.gz dashboard.tar.gz

            echo "âœ… Deployment Complete!"
            docker ps
          EOF

      - name: Reload Nginx
        run: |
          ssh -i ~/.ssh/deploy_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "sudo systemctl reload nginx"
